<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö—ñ–º–Ω–∞—Ç–∞ –¢—Ä–æ—Ñ–µ—ó–≤</title>

    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèÜ</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <style>
        /* –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –¢–µ–º–Ω–æ—ó —Ç–µ–º–∏ */
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --success: #10b981;
            --danger: #f43f5e;
            --danger-hover: #e11d48;
            --highlight: #f59e0b;
            --border: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(15, 23, 42, 0.6);
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --glass-blur: blur(12px);
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –°–≤—ñ—Ç–ª–æ—ó —Ç–µ–º–∏ */
        [data-theme="light"] {
            --bg-color: #f1f5f9;
            --card-bg: rgba(255, 255, 255, 0.8);
            --text-main: #1e293b;
            --text-muted: #64748b;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --success: #059669;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --highlight: #d97706;
            --border: rgba(0, 0, 0, 0.05);
            --input-bg: rgba(241, 245, 249, 0.8);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        body {
            font-family: 'Nunito', system-ui, sans-serif;
            background: radial-gradient(circle at top left, var(--bg-color), var(--bg-color) 80%), var(--bg-color);
            color: var(--text-main);
            margin: 0;
            display: flex;
            justify-content: center;
            padding: 20px;
            min-height: 100vh;
            transition: var(--transition);
        }

        body::before {
            content: '';
            position: fixed;
            top: -100px;
            right: -100px;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: var(--accent);
            filter: blur(150px);
            opacity: 0.15;
            z-index: -1;
        }

        body::after {
            content: '';
            position: fixed;
            bottom: -100px;
            left: -100px;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: var(--success);
            filter: blur(150px);
            opacity: 0.1;
            z-index: -1;
        }

        .container {
            width: 100%;
            max-width: 600px;
            z-index: 1;
        }

        .header-box {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        h1 {
            color: var(--text-main);
            font-size: 2rem;
            font-weight: 800;
            margin: 0;
            flex-grow: 1;
            text-align: center;
            padding-left: 50px;
            letter-spacing: -0.5px;
        }

        h1 span {
            color: var(--highlight);
        }

        .theme-btn {
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border);
            color: var(--text-main);
            font-size: 1.3rem;
            width: 50px;
            height: 50px;
            border-radius: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .theme-btn:hover {
            transform: translateY(-3px) rotate(10deg);
            border-color: var(--accent);
        }

        .status-bar {
            text-align: center;
            font-size: 13px;
            margin-bottom: 25px;
            color: var(--success);
            font-weight: 600;
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
            border: 1px solid var(--border);
            position: relative;
            left: 50%;
            transform: translateX(-50%);
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            padding: 25px;
            border-radius: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        /* --- –ù–û–í–ï: –ü'—î–¥–µ—Å—Ç–∞–ª –†–µ–∫–æ—Ä–¥—ñ–≤ --- */
        .section-title {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--text-muted);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
        }

        .pedestal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .record-card {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(99, 102, 241, 0.05));
            border: 1px solid rgba(245, 158, 11, 0.3);
            text-align: center;
            padding: 20px;
            border-radius: 20px;
            position: relative;
            overflow: hidden;
        }

        .record-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .record-title {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 800;
            text-transform: uppercase;
        }

        .record-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--highlight);
            margin: 5px 0;
            text-shadow: 0 2px 10px rgba(245, 158, 11, 0.2);
        }

        .record-date {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* –ü—Ä–æ–≥—Ä–µ—Å –±–∞—Ä –¥–ª—è —Ü—ñ–ª–µ–π */
        .goal-container {
            margin-top: 15px;
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text-main);
            font-weight: 600;
            margin-bottom: 5px;
        }

        .goal-btn {
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid var(--accent);
            color: var(--text-main);
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .goal-btn:hover {
            background: var(--accent);
            color: white;
        }

        .progress-bg {
            width: 100%;
            height: 8px;
            background: var(--input-bg);
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--success));
            transition: width 0.8s ease-out;
        }

        /* –§–æ—Ä–º–∏ —Ç–∞ —ñ–Ω–ø—É—Ç–∏ */
        label {
            display: block;
            margin-top: 15px;
            color: var(--text-muted);
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        input,
        select {
            width: 100%;
            padding: 14px 18px;
            border-radius: 16px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text-main);
            box-sizing: border-box;
            font-size: 1.05rem;
            font-family: inherit;
            transition: var(--transition);
            outline: none;
        }

        input:focus,
        select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
            background: var(--card-bg);
        }

        .time-inputs {
            display: flex;
            gap: 15px;
        }

        .time-inputs input {
            text-align: center;
        }

        .filter-section {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
        }

        .filter-section label {
            margin: 0;
            white-space: nowrap;
        }

        button.primary-btn {
            width: 100%;
            padding: 16px;
            margin-top: 30px;
            border: none;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--accent), var(--accent-hover));
            color: white;
            font-weight: 800;
            font-size: 1.1rem;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
            font-family: inherit;
        }

        button.primary-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(99, 102, 241, 0.4);
        }

        /* --- –ù–û–í–ï: –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∏–π –¢–∞–π–º–ª–∞–π–Ω --- */
        .timeline-container {
            position: relative;
            padding: 10px 0 10px 20px;
            margin-bottom: 25px;
        }

        .timeline-container::before {
            content: '';
            position: absolute;
            left: 24px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, var(--accent), transparent);
            border-radius: 2px;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            padding: 20px;
            border-radius: 20px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            transition: var(--transition);
            margin-left: 20px;
        }

        .timeline-item:hover {
            transform: translateX(5px);
            border-color: var(--accent);
        }

        .timeline-dot {
            position: absolute;
            left: -45px;
            top: 25px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent);
            border: 3px solid var(--bg-color);
            box-shadow: 0 0 10px var(--accent);
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .timeline-date {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 600;
        }

        .timeline-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .timeline-val {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--text-main);
        }

        .timeline-ex {
            font-size: 1rem;
            color: var(--accent);
            font-weight: 800;
        }

        .diff-badge {
            display: inline-block;
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 800;
            margin-left: 10px;
        }

        .diff-badge.negative {
            background: rgba(244, 63, 94, 0.2);
            color: var(--danger);
        }

        .btn-del {
            background: transparent;
            color: var(--danger);
            border: 1px solid rgba(244, 63, 94, 0.3);
            padding: 6px 12px;
            border-radius: 10px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-del:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .chart-container {
            position: relative;
            height: 280px;
            width: 100%;
        }

        .empty-state {
            text-align: center;
            color: var(--text-muted);
            padding: 20px;
            font-weight: 600;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="header-box">
            <h1>–ö—ñ–º–Ω–∞—Ç–∞ <span>–¢—Ä–æ—Ñ–µ—ó–≤</span></h1>
            <button id="themeToggle" class="theme-btn">‚òÄÔ∏è</button>
        </div>
        <div id="status" class="status-bar">–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Ö–º–∞—Ä–∏...</div>

        <div class="section-title">üèÜ –ê–±—Å–æ–ª—é—Ç–Ω—ñ —Ä–µ–∫–æ—Ä–¥–∏</div>
        <div id="pedestalContainer" class="pedestal-grid">
        </div>

        <div class="card">
            <div class="section-title" style="margin-bottom: 0;">‚ö° –î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π —Ä–µ–∫–æ—Ä–¥</div>

            <label>–í–ø—Ä–∞–≤–∞</label>
            <select id="exSelect" onchange="uiLogic()">
                <option value="–ü—ñ–¥—Ç—è–≥—É–≤–∞–Ω–Ω—è">–ü—ñ–¥—Ç—è–≥—É–≤–∞–Ω–Ω—è</option>
                <option value="–í—ñ–¥–∂–∏–º–∞–Ω–Ω—è">–í—ñ–¥–∂–∏–º–∞–Ω–Ω—è</option>
                <option value="–ë—Ä—É—Å–∏">–ë—Ä—É—Å–∏</option>
                <option value="–ë—ñ–≥">–ë—ñ–≥</option>
                <option value="custom">–Ü–Ω—à–µ...</option>
            </select>

            <input type="text" id="customEx" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –≤–ø—Ä–∞–≤–∏" style="display:none; margin-top:15px;">

            <label>–î–∞—Ç–∞</label>
            <input type="date" id="workoutDate">

            <div id="countContainer">
                <label>–†–µ–∑—É–ª—å—Ç–∞—Ç (–∫—ñ–ª—å–∫—ñ—Å—Ç—å)</label>
                <input type="number" id="workoutCount" placeholder="0">

                <label>–ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                <div class="time-inputs">
                    <input type="number" id="exMin" placeholder="–•–≤">
                    <input type="number" id="exSec" placeholder="–°–µ–∫" max="59">
                </div>
            </div>

            <div id="timeContainer" style="display:none;">
                <label>–í—ñ–¥—Å—Ç–∞–Ω—å (–∫–º)</label>
                <input type="number" id="runDistance" placeholder="0" step="0.1">
                <label>–ß–∞—Å (—Ö–≤:—Å–µ–∫)</label>
                <div class="time-inputs">
                    <input type="number" id="runMin" placeholder="–•–≤">
                    <input type="number" id="runSec" placeholder="–°–µ–∫" max="59">
                </div>
            </div>
            <div id="customResultContainer" style="display:none;">
                <label>–†–µ–∑—É–ª—å—Ç–∞—Ç (–Ω–∞–ø—Ä., "6 –ø–æ 100–º" –∞–±–æ "50 –∫–≥")</label>
                <input type="text" id="customResultStr" placeholder="–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç">

                <label>–ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                <div class="time-inputs">
                    <input type="number" id="customMin" placeholder="–•–≤">
                    <input type="number" id="customSec" placeholder="–°–µ–∫" max="59">
                </div>
            </div>

            <button id="saveBtn" class="primary-btn">–ó–±–µ—Ä–µ–≥—Ç–∏ —Ç—Ä–æ—Ñ–µ–π</button>
        </div>

        <div class="card filter-section">
            <label>–Ü—Å—Ç–æ—Ä—ñ—è:</label>
            <select id="filterSelect" onchange="renderUI()">
                <option value="all">–£—Å—ñ —Ä–µ–∫–æ—Ä–¥–∏</option>
            </select>
        </div>

        <div id="timelineContainer" class="timeline-container">
        </div>

        <div class="card">
            <div class="chart-container">
                <canvas id="progressChart"></canvas>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc }
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyApcu3R3CoGMjkLYkbPcMntSg6QLqIX6uE",
            authDomain: "myworkout-b87bb.firebaseapp.com",
            projectId: "myworkout-b87bb",
            storageBucket: "myworkout-b87bb.firebasestorage.app",
            messagingSenderId: "195021109964",
            appId: "1:195021109964:web:c2c278ded480c7acfbe069",
            measurementId: "G-179ZG65WMS"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const colRef = collection(db, "workouts");

        const MY_PASSWORD = "65";

        // === –õ–û–ì–Ü–ö–ê –¢–ï–ú ===
        const themeBtn = document.getElementById('themeToggle');
        const savedTheme = localStorage.getItem('workoutTheme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        themeBtn.innerText = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';

        themeBtn.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('workoutTheme', newTheme);
            themeBtn.innerText = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            renderUI();
        });

        document.getElementById('workoutDate').valueAsDate = new Date();
        let allWorkouts = [];
        let myChartInstance = null;
        window.uiLogic = () => {
            const select = document.getElementById('exSelect').value;
            const custom = document.getElementById('customEx');
            const countBox = document.getElementById('countContainer');
            const timeBox = document.getElementById('timeContainer');
            const customResBox = document.getElementById('customResultContainer');

            custom.style.display = (select === 'custom') ? 'block' : 'none';

            if (select === '–ë—ñ–≥') {
                countBox.style.display = 'none';
                timeBox.style.display = 'block';
                customResBox.style.display = 'none';
            } else if (select === 'custom') {
                countBox.style.display = 'none';
                timeBox.style.display = 'none';
                customResBox.style.display = 'block';
            } else {
                countBox.style.display = 'block';
                timeBox.style.display = 'none';
                customResBox.style.display = 'none';
            }
        };
        window.updateDropdowns = () => {
            const dbExercises = [...new Set(allWorkouts.map(w => w.exercise))];
            const baseExercises = ["–ü—ñ–¥—Ç—è–≥—É–≤–∞–Ω–Ω—è", "–í—ñ–¥–∂–∏–º–∞–Ω–Ω—è", "–ë—Ä—É—Å–∏", "–ë—ñ–≥"];
            const combined = [...new Set([...baseExercises, ...dbExercises])];

            const exSelect = document.getElementById('exSelect');
            const currentEx = exSelect.value;
            exSelect.innerHTML = combined.map(ex => `<option value="${ex}">${ex}</option>`).join('') + `<option value="custom">–Ü–Ω—à–µ...</option>`;
            if (combined.includes(currentEx) || currentEx === 'custom') exSelect.value = currentEx;

            const filterSelect = document.getElementById('filterSelect');
            const currentFilter = filterSelect.value;
            filterSelect.innerHTML = `<option value="all">–£—Å—ñ —Ä–µ–∫–æ—Ä–¥–∏</option>` + combined.map(ex => `<option value="${ex}">${ex}</option>`).join('');
            if (combined.includes(currentFilter) || currentFilter === 'all') filterSelect.value = currentFilter;
        };

        // –î–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —á–∏—Å–ª–∞ –∑ —Ä—è–¥–∫–∞ (–Ω–∞–ø—Ä. "15 (2:00)" -> 15, "5.5 –∫–º" -> 5.5)
        function parseValue(valStr) {
            const num = parseFloat(valStr);
            return isNaN(num) ? 0 : num;
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —Ü—ñ–ª—ñ
        window.setGoal = (exercise) => {
            const currentGoal = localStorage.getItem('goal_' + exercise) || '';
            const newGoal = prompt(`–í–≤–µ–¥—ñ—Ç—å –≤–∞—à—É —Ü—ñ–ª—å –¥–ª—è "${exercise}":`, currentGoal);
            if (newGoal !== null && newGoal.trim() !== '') {
                const numGoal = parseFloat(newGoal);
                if (!isNaN(numGoal) && numGoal > 0) {
                    localStorage.setItem('goal_' + exercise, numGoal);
                    renderUI(); // –ü–µ—Ä–µ–º–∞–ª—å–æ–≤—É—î–º–æ UI
                } else {
                    alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–µ —á–∏—Å–ª–æ.");
                }
            }
        };

        // –§—É–Ω–∫—Ü—ñ—è —Ä–µ–Ω–¥–µ—Ä—É –ü'—î–¥–µ—Å—Ç–∞–ª—É (–ê–±—Å–æ–ª—é—Ç–Ω—ñ —Ä–µ–∫–æ—Ä–¥–∏ + –¶—ñ–ª—ñ)
        function renderPedestal() {
            const container = document.getElementById('pedestalContainer');
            const exercises = [...new Set(allWorkouts.map(w => w.exercise))];

            if (exercises.length === 0) {
                container.innerHTML = '<div class="empty-state">–©–µ –Ω–µ–º–∞—î –∂–æ–¥–Ω–æ–≥–æ —Ç—Ä–æ—Ñ–µ—é. –ß–∞—Å —Ç—Ä–µ–Ω—É–≤–∞—Ç–∏—Å—å!</div>';
                return;
            }

            let html = '';
            exercises.forEach(ex => {
                const exWorkouts = allWorkouts.filter(w => w.exercise === ex);

                // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —Ä–µ–∫–æ—Ä–¥
                let maxW = exWorkouts[0];
                let maxVal = parseValue(maxW.count);

                exWorkouts.forEach(w => {
                    let val = parseValue(w.count);
                    if (val > maxVal) { maxVal = val; maxW = w; }
                });

                // –õ–æ–≥—ñ–∫–∞ —Ü—ñ–ª–µ–π
                const goal = localStorage.getItem('goal_' + ex);
                let goalHTML = `<button class="goal-btn" onclick="setGoal('${ex}')">+ –ó–∞–¥–∞—Ç–∏ —Ü—ñ–ª—å</button>`;

                if (goal) {
                    const goalNum = parseFloat(goal);
                    let percent = Math.round((maxVal / goalNum) * 100);
                    if (percent > 100) percent = 100;

                    goalHTML = `
                        <div class="goal-header">
                            <span>–¶—ñ–ª—å: ${goalNum}</span>
                            <span>${percent}%</span>
                        </div>
                        <div class="progress-bg">
                            <div class="progress-fill" style="width: ${percent}%;"></div>
                        </div>
                        <div style="text-align:right; margin-top:5px;">
                            <button class="goal-btn" style="padding:2px 5px; font-size: 0.65rem;" onclick="setGoal('${ex}')">–ó–º—ñ–Ω–∏—Ç–∏</button>
                        </div>
                    `;
                }

                let icon = 'üèÖ';
                if (ex === '–ë—ñ–≥') icon = 'üèÉ‚Äç‚ôÇÔ∏è';
                if (ex === '–ü—ñ–¥—Ç—è–≥—É–≤–∞–Ω–Ω—è') icon = 'ü¶ç';
                if (ex === '–í—ñ–¥–∂–∏–º–∞–Ω–Ω—è') icon = 'üî•';

                html += `
                    <div class="record-card">
                        <div class="record-icon">${icon}</div>
                        <div class="record-title">${ex}</div>
                        <div class="record-value">${maxW.count}</div>
                        <div class="record-date">${maxW.date}</div>
                        <div class="goal-container">${goalHTML}</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        window.renderUI = () => {
            renderPedestal();

            const filterValue = document.getElementById('filterSelect').value;
            const container = document.getElementById('timelineContainer');
            container.innerHTML = '';

            const filteredWorkouts = (filterValue === 'all')
                ? allWorkouts
                : allWorkouts.filter(w => w.exercise === filterValue);

            if (filteredWorkouts.length === 0) {
                container.innerHTML = '<div class="empty-state">–ó–∞–ø–∏—Å—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';
                updateChart(filteredWorkouts, filterValue);
                return;
            }

            // –†–µ–Ω–¥–µ—Ä –¢–∞–π–º–ª–∞–π–Ω—É (–∑ –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫–æ–º —Ä—ñ–∑–Ω–∏—Ü—ñ)
            filteredWorkouts.forEach((w, index) => {
                let diffHTML = '';

                // –ü–æ–∫–∞–∑—É—î–º–æ —Ä—ñ–∑–Ω–∏—Ü—é –¢–Ü–õ–¨–ö–ò —è–∫—â–æ –≤–∏–±—Ä–∞–Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞ –≤–ø—Ä–∞–≤–∞ —ñ —î –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∑–∞–ø–∏—Å
                if (filterValue !== 'all' && index < filteredWorkouts.length - 1) {
                    let prevW = filteredWorkouts[index + 1]; // –ù–∞—Å—Ç—É–ø–Ω–∏–π –≤ –º–∞—Å–∏–≤—ñ = –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –≤ —á–∞—Å—ñ (–±–æ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è desc)
                    let currentVal = parseValue(w.count);
                    let prevVal = parseValue(prevW.count);
                    let diff = Math.round((currentVal - prevVal) * 100) / 100; // –û–∫—Ä—É–≥–ª–µ–Ω–Ω—è –¥–ª—è –¥–µ—Å—è—Ç–∫–æ–≤–∏—Ö (–∫–º)

                    if (diff > 0) {
                        diffHTML = `<span class="diff-badge">+${diff}</span>`;
                    } else if (diff < 0) {
                        diffHTML = `<span class="diff-badge negative">${diff}</span>`;
                    } else {
                        diffHTML = `<span class="diff-badge" style="background:var(--border); color:var(--text-muted);">–ë–µ–∑ –∑–º—ñ–Ω</span>`;
                    }
                }

                const exLabel = filterValue === 'all' ? `<div class="timeline-ex">${w.exercise}</div>` : '';

                container.innerHTML += `
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-header">
                            <span class="timeline-date">${w.date}</span>
                            <button class="btn-del" onclick="deleteEntry('${w.id}')">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                        </div>
                        ${exLabel}
                        <div class="timeline-content">
                            <span class="timeline-val">${w.count} ${diffHTML}</span>
                        </div>
                    </div>`;
            });

            updateChart(filteredWorkouts, filterValue);
        };

        function updateChart(filteredWorkouts, filterValue) {
            const ctx = document.getElementById('progressChart').getContext('2d');
            if (myChartInstance) myChartInstance.destroy();

            const style = getComputedStyle(document.body);
            const textColor = style.getPropertyValue('--text-muted').trim() || '#888';
            const gridColor = style.getPropertyValue('--border').trim() || 'rgba(255,255,255,0.1)';
            const accentColor = style.getPropertyValue('--accent').trim() || '#6366f1';

            const chartData = [...filteredWorkouts].reverse();
            let labels = [];
            let dataPoints = [];
            let datasetLabel = "";

            if (filterValue === 'all') {
                datasetLabel = "–¢—Ä–æ—Ñ–µ—ó–≤ –∑–∞ –¥–µ–Ω—å";
                let dateCounts = {};
                chartData.forEach(w => { dateCounts[w.date] = (dateCounts[w.date] || 0) + 1; });
                labels = Object.keys(dateCounts);
                dataPoints = Object.values(dateCounts);
            } else {
                datasetLabel = (filterValue === '–ë—ñ–≥') ? "–í—ñ–¥—Å—Ç–∞–Ω—å (–∫–º)" : "–ü–æ–≤—Ç–æ—Ä–µ–Ω–Ω—è";
                chartData.forEach(w => {
                    labels.push(w.date);
                    dataPoints.push(parseValue(w.count));
                });
            }

            let gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(99, 102, 241, 0.5)');
            gradient.addColorStop(1, 'rgba(99, 102, 241, 0.0)');

            myChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: datasetLabel,
                        data: dataPoints,
                        borderColor: accentColor,
                        backgroundColor: gradient,
                        borderWidth: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: accentColor,
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: textColor, font: { family: 'Nunito', weight: 'bold' } } },
                        tooltip: { backgroundColor: 'rgba(15, 23, 42, 0.9)', titleFont: { family: 'Nunito', size: 14 }, bodyFont: { family: 'Nunito', size: 14 }, padding: 12, cornerRadius: 12 }
                    },
                    scales: {
                        x: { ticks: { color: textColor, font: { family: 'Nunito' } }, grid: { color: gridColor, drawBorder: false } },
                        y: { ticks: { color: textColor, font: { family: 'Nunito' } }, grid: { color: gridColor, drawBorder: false, borderDash: [5, 5] }, beginAtZero: true }
                    }
                }
            });
        }

        onSnapshot(query(colRef, orderBy("date", "desc")), (snapshot) => {
            allWorkouts = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));

            updateDropdowns();
            renderUI();
            document.getElementById('status').innerText = "–•–º–∞—Ä–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–∞ ‚úÖ";
        });

        document.getElementById('saveBtn').addEventListener('click', async () => {
            const userPass = prompt("–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ä–µ–∫–æ—Ä–¥—É:");
            if (userPass !== MY_PASSWORD) {
                alert("–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å! –ó–º—ñ–Ω–∏ –Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–æ.");
                return;
            }

            const select = document.getElementById('exSelect').value;
            const customName = document.getElementById('customEx').value;
            const date = document.getElementById('workoutDate').value;

            let exerciseName = (select === 'custom') ? customName : select;
            let finalResult = "";

            if (select === '–ë—ñ–≥') {
                const dist = document.getElementById('runDistance').value;
                const min = document.getElementById('runMin').value || "0";
                const sec = document.getElementById('runSec').value || "00";
                if (!dist || (!min && !sec)) { alert("–í–∫–∞–∂–∏ –≤—ñ–¥—Å—Ç–∞–Ω—å —Ç–∞ —á–∞—Å –±—ñ–≥—É!"); return; }
                finalResult = `${dist} –∫–º (${min}:${sec.padStart(2, '0')})`;
            }
            else if (select === 'custom') {
                // –ù–û–í–ê –õ–û–ì–Ü–ö–ê –î–õ–Ø "–Ü–ù–®–ï..."
                const customRes = document.getElementById('customResultStr').value;
                const customMin = document.getElementById('customMin').value;
                const customSec = document.getElementById('customSec').value;

                if (!customRes) { alert("–í–∫–∞–∂–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–Ω–∞–ø—Ä. '6 –ø–æ 100–º')!"); return; }

                if (customMin || customSec) {
                    finalResult = `${customRes} (${customMin || "0"}:${(customSec || "0").padStart(2, '0')})`;
                } else {
                    finalResult = customRes;
                }
            }
            else {
                const count = document.getElementById('workoutCount').value;
                const exMin = document.getElementById('exMin').value;
                const exSec = document.getElementById('exSec').value;
                if (!count) { alert("–í–∫–∞–∂–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω—å!"); return; }
                if (exMin || exSec) {
                    finalResult = `${count} (${exMin || "0"}:${(exSec || "0").padStart(2, '0')})`;
                } else {
                    finalResult = count;
                }
            }

            if (!exerciseName) { alert("–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –≤–ø—Ä–∞–≤–∏!"); return; }

            try {
                document.getElementById('status').innerText = "–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...";
                await addDoc(colRef, {
                    exercise: exerciseName, date: date, count: finalResult, createdAt: Date.now()
                });

                // –û—á–∏—â–∞—î–º–æ –≤—Å—ñ –ø–æ–ª—è –ø—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
                document.getElementById('workoutCount').value = '';
                document.getElementById('exMin').value = '';
                document.getElementById('exSec').value = '';
                document.getElementById('runDistance').value = '';
                document.getElementById('runMin').value = '';
                document.getElementById('runSec').value = '';
                document.getElementById('customEx').value = '';
                document.getElementById('customResultStr').value = '';
                document.getElementById('customMin').value = '';
                document.getElementById('customSec').value = '';
            } catch (err) { alert("–ü–æ–º–∏–ª–∫–∞: " + err.message); }
        });

        window.deleteEntry = async (id) => {
            const userPass = prompt("–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–ø–∏—Å—É:");
            if (userPass !== MY_PASSWORD) { alert("–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å! –î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ."); return; }
            if (confirm("–¢–æ—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø–∏—Å?")) {
                await deleteDoc(doc(db, "workouts", id));
            }
        };
    </script>
</body>


</html>
